<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - StudyCloud</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/templatemo-glass-admin-style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .countdown-timer {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        
        .countdown-urgent {
            color: #ef4444;
            font-weight: 600;
        }
        
        .countdown-soon {
            color: #f59e0b;
            font-weight: 600;
        }
        
        .countdown-normal {
            color: var(--text-secondary);
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="animated-bg"></div>
    
    <!-- Navigation -->
    <nav class="glass-nav">
        <div class="nav-brand">
            <i class="fas fa-cloud"></i> StudyCloud
        </div>
        <ul class="nav-menu">
            <li><a href="{{ url_for('dashboard') }}" class="active"><i class="fas fa-home"></i> Dashboard</a></li>
            <li><a href="{{ url_for('add_task') }}"><i class="fas fa-plus"></i> Add Task</a></li>
            <li><a href="{{ url_for('analytics') }}"><i class="fas fa-chart-bar"></i> Analytics</a></li>
            {% if current_user.username == 'admin' %}
            <li><a href="{{ url_for('admin_panel') }}"><i class="fas fa-user-shield"></i> Admin</a></li>
            {% endif %}
            <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- üéÆ WELCOME & GAMIFICATION HEADER -->
        <div class="glass-card" style="margin-bottom: 30px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 20px;">
                <!-- Welcome Message -->
                <div>
                    <h1 style="font-size: 32px; font-weight: 700; margin: 0 0 10px 0; background: linear-gradient(135deg, #6366f1, #a855f7); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        Welcome back, {{ current_user.username }}! üëã
                    </h1>
                    <p style="color: var(--text-secondary); margin: 0;">Ready to conquer your tasks today?</p>
                </div>
                
                <!-- Gamification Stats -->
                <div style="display: flex; gap: 20px; align-items: center;">
                    <!-- Level -->
                    <div style="text-align: center; padding: 15px 25px; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 15px;">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">LEVEL</div>
                        <div style="font-size: 32px; font-weight: 700; background: linear-gradient(135deg, #fbbf24, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            {{ current_user.level }}
                        </div>
                    </div>
                    
                    <!-- Points -->
                    <div style="text-align: center; padding: 15px 25px; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 15px;">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">POINTS</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">
                            {{ current_user.points }}
                        </div>
                        <div style="font-size: 10px; color: var(--text-secondary); margin-top: 5px;">
                            {{ current_user.points_to_next_level() }} to Level {{ current_user.level + 1 }}
                        </div>
                    </div>
                    
                    <!-- Badges -->
                    <div style="text-align: center; padding: 15px 25px; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 15px;">
                        <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 5px;">BADGES</div>
                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">
                            üèÜ {{ user_badges|length }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Progress Bar to Next Level -->
            <div style="margin-top: 20px;">
                <div style="display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">
                    <span>Level {{ current_user.level }}</span>
                    <span>Level {{ current_user.level + 1 }}</span>
                </div>
                <div style="height: 12px; background: var(--glass-bg); border-radius: 10px; overflow: hidden; border: 1px solid var(--glass-border);">
                    <div style="height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7); width: {{ ((current_user.points % 100) / 100 * 100)|int }}%; transition: width 0.5s ease;"></div>
                </div>
            </div>
        </div>

        <!-- üèÜ BADGES SHOWCASE -->
        {% if user_badges %}
        <div class="glass-card" style="margin-bottom: 30px;">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <h3 style="margin: 0; font-size: 20px; font-weight: 600;">Your Badges</h3>
                <span style="padding: 4px 12px; background: rgba(168, 85, 247, 0.2); border-radius: 20px; font-size: 12px; color: var(--text-primary);">
                    {{ user_badges|length }} Earned
                </span>
            </div>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                {% for badge in user_badges %}
                <div style="padding: 20px; background: var(--glass-bg); border: 2px solid var(--glass-border); border-radius: 15px; text-align: center; min-width: 120px;">
                    <div style="font-size: 36px; margin-bottom: 10px;">
                        {% if badge == 'First Step' %}üéØ
                        {% elif badge == 'Task Master' %}‚ö°
                        {% elif badge == 'Productivity Legend' %}üöÄ
                        {% elif badge == 'Century Club' %}üíé
                        {% else %}üèÜ{% endif %}
                    </div>
                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">{{ badge }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ all_count }}</h3>
                    <p>Total Tasks</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ complete_count }}</h3>
                    <p>Completed</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ incomplete_count }}</h3>
                    <p>Pending</p>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div class="glass-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
                <h2 style="margin: 0; font-size: 24px; font-weight: 600;">Your Tasks</h2>
                
                <!-- Filters -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <form method="GET" style="display: flex; gap: 10px;">
                        <select name="status" class="form-control" onchange="this.form.submit()">
                            <option value="all" {% if filter_status == 'all' %}selected{% endif %}>All Status</option>
                            <option value="complete" {% if filter_status == 'complete' %}selected{% endif %}>Complete</option>
                            <option value="incomplete" {% if filter_status == 'incomplete' %}selected{% endif %}>Incomplete</option>
                        </select>
                        
                        <select name="priority" class="form-control" onchange="this.form.submit()">
                            <option value="all" {% if filter_priority == 'all' %}selected{% endif %}>All Priority</option>
                            <option value="high" {% if filter_priority == 'high' %}selected{% endif %}>High</option>
                            <option value="medium" {% if filter_priority == 'medium' %}selected{% endif %}>Medium</option>
                            <option value="low" {% if filter_priority == 'low' %}selected{% endif %}>Low</option>
                        </select>
                    </form>
                </div>
            </div>

            <!-- Tasks Table -->
            {% if tasks %}
            <div style="overflow-x: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Priority</th>
                            <th>Due Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for task in tasks %}
                        <tr>
                            <td style="font-weight: 600;">{{ task.title }}</td>
                            <td style="color: var(--text-secondary); max-width: 300px;">
                                {{ task.description[:50] }}{% if task.description|length > 50 %}...{% endif %}
                            </td>
                            <td>
                                {% if task.priority == 'high' %}
                                    <span class="badge badge-danger">üî¥ High</span>
                                {% elif task.priority == 'medium' %}
                                    <span class="badge badge-warning">üü° Medium</span>
                                {% else %}
                                    <span class="badge badge-info">üü¢ Low</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.due_date %}
                                    <div>{{ task.due_date.strftime('%Y-%m-%d') }}</div>
                                    <div class="countdown-timer" data-due="{{ task.due_date.isoformat() }}">
                                        Calculating...
                                    </div>
                                {% else %}
                                    <span style="color: var(--text-secondary);">No due date</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if task.status == 'complete' %}
                                    <span class="badge badge-success">‚úì Complete</span>
                                {% else %}
                                    <span class="badge badge-secondary">‚óã Incomplete</span>
                                {% endif %}
                            </td>
                            <td>
                                <div style="display: flex; gap: 8px;">
                                    <a href="{{ url_for('toggle_task', task_id=task.id) }}" 
                                       class="btn btn-sm" 
                                       style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                                        {% if task.status == 'complete' %}
                                            <i class="fas fa-undo"></i>
                                        {% else %}
                                            <i class="fas fa-check"></i>
                                        {% endif %}
                                    </a>
                                    <a href="{{ url_for('delete_task', task_id=task.id) }}" 
                                       class="btn btn-sm" 
                                       style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;"
                                       onclick="return confirm('Are you sure you want to delete this task?')">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div style="text-align: center; padding: 60px 20px;">
                <i class="fas fa-tasks" style="font-size: 64px; color: var(--text-secondary); opacity: 0.3; margin-bottom: 20px;"></i>
                <h3 style="color: var(--text-secondary); margin-bottom: 10px;">No tasks found</h3>
                <p style="color: var(--text-secondary); margin-bottom: 30px;">Start by creating your first task!</p>
                <a href="{{ url_for('add_task') }}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Task
                </a>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Countdown Timer Script -->
    <script>
        function updateCountdowns() {
            const countdownElements = document.querySelectorAll('.countdown-timer');
            
            countdownElements.forEach(element => {
                const dueDate = new Date(element.dataset.due);
                const now = new Date();
                const diff = dueDate - now;
                
                if (diff < 0) {
                    element.textContent = '‚è∞ Overdue!';
                    element.className = 'countdown-timer countdown-urgent';
                } else {
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    let timeText = '';
                    let className = 'countdown-timer ';
                    
                    if (days > 7) {
                        timeText = `üìÖ ${days} days left`;
                        className += 'countdown-normal';
                    } else if (days > 1) {
                        timeText = `‚è≥ ${days} days, ${hours}h left`;
                        className += 'countdown-soon';
                    } else if (days === 1) {
                        timeText = `‚ö†Ô∏è ${days} day, ${hours}h left`;
                        className += 'countdown-urgent';
                    } else if (hours > 0) {
                        timeText = `üî• ${hours}h ${minutes}m left`;
                        className += 'countdown-urgent';
                    } else {
                        timeText = `üö® ${minutes}m left`;
                        className += 'countdown-urgent';
                    }
                    
                    element.textContent = timeText;
                    element.className = className;
                }
            });
        }
        
        // Update immediately and then every minute
        updateCountdowns();
        setInterval(updateCountdowns, 60000);
    </script>
</body>
</html>
